<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.lec.spring.member.repository.FriendRepository">

    <!-- 친구 요청 보내기 -->
    <insert id="sendFriendRequest" parameterType="com.lec.spring.member.domain.Friend" flushCache="true">
        INSERT INTO friend(sender_id, receiver_id, intimacy, is_accept)
        VALUES (#{senderId}, #{receiverId}, #{intimacy}, #{isAccept})
    </insert>

    <!-- 친구 요청 수락 -->
    <update id="acceptFriendRequest" parameterType="com.lec.spring.member.domain.Friend">
        UPDATE friend
        SET is_accept = true
        WHERE sender_id = #{senderId}
          AND receiver_id = #{receiverId}
    </update>

    <!-- 친구 요청 거절 / 삭제 -->
    <delete id="rejectFriendRequest" parameterType="com.lec.spring.member.domain.Friend" flushCache="true">
        DELETE
        FROM friend
        WHERE receiver_id = #{receiverId}
          and sender_id = #{senderId}
    </delete>

    <!-- 친구 신청 보낼 때 이미 보낸/받은 신청은 아닌지 확인 -->
    <select id="isAlreadyFriend" parameterType="com.lec.spring.member.domain.Friend" resultType="boolean">
        SELECT count(*)
        FROM friend f
        WHERE (sender_id = #{senderId} and receiver_id = #{receiverId})
           or (sender_id = #{receiverId} and receiver_id = #{senderId})
    </select>

    <!-- 수락된 친구 목록 조회 -->
    <select id="findFriendsWithDetailsDTO" resultType="com.lec.spring.member.domain.FriendDetailsDTO"
            parameterType="long">
        SELECT m.id                                                 AS friendId,
               pi.filename                                          AS profileImg,
               m.nickname                                           AS nickname,
               m.username                                           AS username,
               COUNT(CASE WHEN mm.visibility = 'PUBLIC' THEN 1 END) AS publicCount,
               COUNT(CASE WHEN mm.visibility = 'HIDDEN' THEN 1 END) AS hiddenCount,
               f.intimacy                                           AS intimacy
        FROM friend f
                 JOIN member m ON (f.sender_id = m.id OR f.receiver_id = m.id)
                 LEFT JOIN profile_img pi ON m.id = pi.member_id
                 LEFT JOIN my_matzip mm ON m.id = mm.member_id
        WHERE (f.sender_id = #{memberId} OR f.receiver_id = #{memberId})
          AND f.is_accept = TRUE
          AND m.id != #{memberId} -- 본인 ID 제외
        GROUP BY
            m.id, pi.filename, m.nickname, m.username, f.intimacy;
    </select>


    <resultMap id="FriendWithDetailsMap" type="com.lec.spring.member.domain.Friend">
        <id property="senderId" column="sender_id"/>
        <result property="receiverId" column="receiver_id"/>
        <result property="intimacy" column="intimacy"/>
        <result property="isAccept" column="is_accept"/>
        <result property="regdate" column="regdate"/>
        <association property="friendDetails" javaType="com.lec.spring.member.domain.FriendDetailsDTO">
            <id property="friendId" column="friendId"/>
            <result property="nickname" column="nickname"/>
            <result property="username" column="username"/>
            <result property="profileImg" column="profileImg"/>
            <result property="publicCount" column="public_count"/>
            <result property="hiddenCount" column="hidden_count"/>
        </association>
    </resultMap>

    <select id="findPendingRequests" resultMap="FriendWithDetailsMap">
        SELECT f.sender_id,
               f.receiver_id,
               f.intimacy,
               f.is_accept,
               f.regdate,
               m.nickname,
               m.username,
               m.id                                                 as friendId,
               p.filename                                           as profileImg,
               COUNT(CASE WHEN mm.visibility = 'PUBLIC' THEN 1 END) as public_count,
               COUNT(CASE WHEN mm.visibility = 'HIDDEN' THEN 1 END) as hidden_count
        FROM friend f
                 JOIN member m ON f.sender_id = m.id  -- 요청을 보낸 사람의 정보를 가져옴
                 LEFT JOIN profile_img p ON m.id = p.member_id
                 LEFT JOIN my_matzip mm ON m.id = mm.member_id
        WHERE f.receiver_id = #{id}  -- 내가 받은 요청만
          AND f.is_accept = false
        GROUP BY f.sender_id,
                 f.receiver_id,
                 f.intimacy,
                 f.is_accept,
                 f.regdate,
                 m.nickname,
                 m.username,
                 m.id,
                 p.filename
    </select>

    <!-- 친구 검색 -->
    <!-- 친구 검색 -->
    <select id="searchPotentialFriends" resultType="com.lec.spring.member.domain.FriendSearchResponseDTO">
        SELECT DISTINCT
            m.id AS id,
            m.username AS username,
            m.nickname AS nickname,
            pi.filename AS profileImg,
            COUNT(CASE WHEN mm.visibility = 'PUBLIC' THEN 1 END) AS publicCount,
            COUNT(CASE WHEN mm.visibility = 'HIDDEN' THEN 1 END) AS hiddenCount
        FROM member m
                 LEFT JOIN profile_img pi ON m.id = pi.member_id
                 LEFT JOIN my_matzip mm ON m.id = mm.member_id
        WHERE
            m.id != #{currentMemberId}
          AND m.id NOT IN (
            SELECT DISTINCT
            CASE
            WHEN sender_id = #{currentMemberId} THEN receiver_id
            WHEN receiver_id = #{currentMemberId} THEN sender_id
            END
            FROM friend
            WHERE (sender_id = #{currentMemberId} OR receiver_id = #{currentMemberId})
            )
          AND (
            LOWER(m.nickname) LIKE CONCAT('%', LOWER(#{searchTerm}), '%')
           OR LOWER(m.username) LIKE CONCAT('%', LOWER(#{searchTerm}), '%')
            )
          AND #{searchTerm} != ''
        GROUP BY
            m.id, m.username, m.nickname, pi.filename;
    </select>


    <!-- 친밀도 업데이트 -->
    <update id="updateIntimacy" flushCache="true">
        UPDATE friend f
        SET f.intimacy = f.intimacy + #{member.intimacy}
        WHERE f.is_accept = TRUE
          AND (
            (f.sender_id = #{memberId} AND f.receiver_id = #{targetId})
                OR (f.receiver_id = #{memberId} AND f.sender_id = #{targetId})
            )
    </update>

</mapper>
